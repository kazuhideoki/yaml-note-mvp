# Phase 2: Raw YAML エディタ実装

## 目標

仕様書に記載の通り、Phase 2では以下を実現します：

- CodeMirror を使用した YAML エディタの実装
- ファイルの Open/Save 機能の実装

## 1. 開発環境セットアップ

### 依存パッケージのインストール

- [ ] CodeMirror パッケージのインストール
  ```bash
  cd apps/web
  pnpm add @codemirror/state @codemirror/view @codemirror/language @codemirror/language-data @codemirror/lint @codemirror/commands @uiw/react-codemirror
  ```
- [ ] YAML 構文ハイライト用パッケージのインストール
  ```bash
  pnpm add @codemirror/lang-yaml
  ```
- [ ] ファイルI/O用のreactブラウザAPI（FileSystem Access API）ユーティリティのインストール
  ```bash
  pnpm add browser-fs-access
  ```

## 2. YAML エディタコンポーネントの実装

### YamlEditor.tsx の作成

- [ ] React コンポーネントの作成
  - apps/web/src/components/YamlEditor.tsx を作成
  - CodeMirror インスタンスの基本設定 (テーマ、行番号、ハイライト)
- [ ] YAML 編集機能の実装
  - YAML 構文ハイライト設定
  - 変更イベントハンドラー (onChange)
  - 初期値設定機能
- [ ] エディタのスタイル調整
  - Tailwind CSS を使った見た目の調整
  - レスポンシブデザインの対応

### コンポーネントのテスト作成

- [ ] 基本的なレンダリングテスト
  - 初期値が正しく表示されるか
  - 変更イベントが発火するか

## 3. ファイルアクセス機能の実装

### useFileAccess.ts の作成

- [ ] hooks ディレクトリの作成
  ```bash
  mkdir -p apps/web/src/hooks
  ```
- [ ] カスタムフックの実装
  - apps/web/src/hooks/useFileAccess.ts を作成
  - ファイルを開く機能 (openFile)
  - ファイルを保存する機能 (saveFile)
  - 最近使用したファイルの管理 (オプション)
- [ ] エラーハンドリングの実装
  - ファイルアクセス権限エラーの処理
  - 無効なファイル形式の処理

## 4. アプリケーションへの統合

### App.tsx の拡張

- [ ] レイアウト構造の実装
  - エディタペインの配置
  - ファイルオープン/保存ボタンの追加
- [ ] 状態管理の実装
  - 現在のYAML内容の状態管理
  - ファイル名と変更状態の管理
- [ ] イベントハンドラの連携
  - ファイルオープン/保存ボタンと useFileAccess の連携
  - エディタの変更と状態更新の連携

## 5. ユーザー体験(UX)の向上

### UI/UX の調整

- [ ] フィードバック UI の追加
  - ファイル操作の結果表示
  - 保存状態のインジケータ
- [ ] キーボードショートカットの実装
  - Ctrl+S / Cmd+S で保存
  - Ctrl+O / Cmd+O でファイルオープン
- [ ] ドラッグ&ドロップ対応 (オプション)
  - YAML ファイルのD&D対応

## 6. 動作確認

### エディタ機能の確認

- [ ] YAML 編集とハイライト表示が正しく機能するか確認
  - 構文ハイライトが正しく表示されるか
  - 行番号が表示されるか
  - エディタの基本機能（コピー/ペースト/アンドゥ等）が動作するか

### ファイル操作の確認

- [ ] ファイルオープン機能のテスト
  - sample/note.yaml を正しく開けるか
  - 内容が正しく表示されるか
- [ ] ファイル保存機能のテスト
  - 変更した内容が正しく保存されるか
  - 新規ファイル作成が機能するか

## 完了条件

- [ ] 基本的なテストがすべて成功すること
- [ ] 仕様書に記載の「Phase 2」の deliverables が揃っていること
  - YamlEditor.tsx ✓
  - useFileAccess.ts ✓
- [ ] 仕様に記載された exit_condition を満たすこと
  - 「ハイライト付きエディタ表示」が実現できていること
  - 「Open→編集→Save が動く」ことが確認できていること

## 実装メモ

### CodeMirror 実装のポイント

```typescript
// YamlEditor.tsx サンプルコード（参考）
import React, { useCallback } from 'react';
import CodeMirror from '@uiw/react-codemirror';
import { yaml } from '@codemirror/lang-yaml';
import { EditorView } from '@codemirror/view';

interface YamlEditorProps {
  value: string;
  onChange: (value: string) => void;
}

export const YamlEditor: React.FC<YamlEditorProps> = ({ value, onChange }) => {
  const handleChange = useCallback((value: string) => {
    onChange(value);
  }, [onChange]);

  return (
    <div className="h-full w-full border border-gray-300 rounded">
      <CodeMirror
        value={value}
        height="100%"
        extensions={[yaml(), EditorView.lineWrapping]}
        onChange={handleChange}
        theme="light"
        basicSetup={{
          lineNumbers: true,
          highlightActiveLine: true,
          highlightSelectionMatches: true,
        }}
      />
    </div>
  );
};
```

### ファイルアクセス実装のポイント

```typescript
// useFileAccess.ts サンプルコード（参考）
import { useState } from 'react';
import { fileSave, fileOpen } from 'browser-fs-access';

export function useFileAccess() {
  const [fileName, setFileName] = useState<string | null>(null);
  const [fileHandle, setFileHandle] = useState<any>(null);

  const openFile = async () => {
    try {
      const blob = await fileOpen({
        extensions: ['.yaml', '.yml'],
        description: 'YAML files',
      });
      
      const text = await blob.text();
      setFileName(blob.name);
      
      return { content: text, name: blob.name };
    } catch (error) {
      console.error('Failed to open file:', error);
      return null;
    }
  };

  const saveFile = async (content: string) => {
    try {
      const blob = new Blob([content], { type: 'text/yaml' });
      const savedFile = await fileSave(blob, {
        fileName: fileName || 'note.yaml',
        extensions: ['.yaml'],
      });
      
      if (savedFile) {
        setFileName(savedFile.name);
        setFileHandle(savedFile);
      }
      
      return true;
    } catch (error) {
      console.error('Failed to save file:', error);
      return false;
    }
  };

  return {
    fileName,
    openFile,
    saveFile,
  };
}
```

## 開発ステップ

1. CodeMirror と必要なパッケージをインストール
2. YamlEditor コンポーネントの基本実装
3. useFileAccess フックの実装
4. App.tsx を拡張してコンポーネントを統合
5. UIをTailwind CSSでスタイリング
6. 機能テストと調整
7. ユーザー体験の改善（キーボードショートカットなど）

## 次のフェーズへの準備

Phase 2の完了後、Phase 3（リアルタイムバリデーション）に必要な基盤が整います。特に：

- YamlEditor コンポーネントからの変更通知
- core-wasm との連携準備
- エラー表示領域の確保

これらの要素がPhase 3での実装をスムーズにします。