# Phase 4: Markdown プレビュー実装

## 目標

仕様書に記載の通り、Phase 4では以下を実現します：

- YAML の content フィールドのマークダウンプレビュー
- 編集とプレビューの分割表示
- MarkdownPreview コンポーネントの実装

## 1. 開発環境セットアップ

### 依存パッケージのインストール

- [ ] Markdownレンダリングパッケージのインストール
  ```bash
  cd apps/web
  pnpm add react-markdown remark-gfm rehype-raw rehype-sanitize
  ```
- [ ] シンタックスハイライト用パッケージのインストール (オプション)
  ```bash
  pnpm add rehype-highlight prismjs
  ```
- [ ] スタイル確認用のTailwind拡張設定
  ```bash
  pnpm add -D @tailwindcss/typography
  ```

## 2. MarkdownPreview コンポーネントの実装

### components/MarkdownPreview.tsx の作成

- [ ] React コンポーネントの作成
  - content パラメータを受け取り、マークダウンをレンダリング
  - スクロール同期の準備（オプション）
- [ ] スタイリングの実装
  - Tailwind CSS の typography プラグインを活用
  - テーマに合わせた見た目の調整

### サンプル実装

```typescript
// components/MarkdownPreview.tsx
import React from 'react';
import ReactMarkdown from 'react-markdown';
import remarkGfm from 'remark-gfm';
import rehypeSanitize from 'rehype-sanitize';
import rehypeRaw from 'rehype-raw';

interface MarkdownPreviewProps {
  content: string;
  className?: string;
}

export const MarkdownPreview: React.FC<MarkdownPreviewProps> = ({ 
  content,
  className = '' 
}) => {
  return (
    <div className={`prose prose-slate max-w-none p-4 overflow-auto ${className}`}>
      <ReactMarkdown
        remarkPlugins={[remarkGfm]}
        rehypePlugins={[rehypeSanitize, rehypeRaw]}
      >
        {content}
      </ReactMarkdown>
    </div>
  );
};

export default MarkdownPreview;
```

## 3. YAML から Markdown コンテンツの抽出

### useMarkdownContent フックの実装

- [ ] コンテンツ抽出ロジックの実装
  - YAML から content フィールドを安全に抽出
  - YAML パース時のエラーハンドリング

### サンプル実装

```typescript
// hooks/useMarkdownContent.ts
import { useState, useEffect } from 'react';
import * as yaml from 'js-yaml';

export function useMarkdownContent(yamlString: string) {
  const [markdownContent, setMarkdownContent] = useState<string>('');
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    try {
      // YAMLをパース
      const parsed = yaml.load(yamlString) as any;
      
      // contentフィールドを抽出
      if (parsed && typeof parsed === 'object' && 'content' in parsed) {
        setMarkdownContent(String(parsed.content));
        setError(null);
      } else {
        setMarkdownContent('');
        setError('YAMLにcontentフィールドが見つかりません');
      }
    } catch (err) {
      console.error('YAMLパースエラー:', err);
      setMarkdownContent('');
      setError(`YAMLのパースに失敗しました: ${err}`);
    }
  }, [yamlString]);

  return { markdownContent, error };
}
```

## 4. アプリケーションへの統合

### App.tsx の拡張

- [ ] レイアウト構造の更新
  - 左右分割表示の実装
  - エディタとプレビューの配置
- [ ] 状態管理の拡張
  - useMarkdownContent フックの統合
  - レイアウト表示切り替え (オプション)

### サンプル実装

```typescript
// App.tsx 更新部分
// ...既存のimportに追加
import MarkdownPreview from './components/MarkdownPreview';
import { useMarkdownContent } from './hooks/useMarkdownContent';

// ...App関数内に追加
const { markdownContent, error: mdError } = useMarkdownContent(yaml);

// ...returnのレイアウト部分を更新
return (
  <div className="flex flex-col h-screen bg-slate-100 p-4">
    <header className="flex justify-between items-center mb-4">
      {/* 既存のヘッダー内容 */}
    </header>
    
    <div className="flex-1 mb-4 grid grid-cols-2 gap-4">
      {/* 左側: YAMLエディタ */}
      <div className="relative">
        <YamlEditor
          value={yaml}
          onChange={handleYamlChange}
          className="h-full"
          editorRef={editorRef}
        />
        
        {/* エラーバッジ */}
        {!validationResult.success && (
          <ErrorBadge 
            errors={validationResult.errors} 
            onClick={handleErrorClick}
          />
        )}
      </div>
      
      {/* 右側: マークダウンプレビュー */}
      <div className="bg-white rounded-md shadow overflow-auto">
        {mdError ? (
          <div className="p-4 text-red-600">{mdError}</div>
        ) : (
          <MarkdownPreview content={markdownContent} />
        )}
      </div>
    </div>
    
    <footer className="flex justify-between text-sm text-gray-500">
      {/* 既存のフッター内容 */}
    </footer>
  </div>
);
```

## 5. Tailwind Typography の設定

### tailwind.config.js の更新

- [ ] Typography プラグインの追加
  ```javascript
  // tailwind.config.js
  module.exports = {
    // ...その他の設定
    plugins: [
      require('@tailwindcss/typography'),
      // ...その他のプラグイン
    ],
  };
  ```

## 6. UX 強化機能 (オプション)

### スクロール同期の実装

- [ ] エディタとプレビュー間のスクロール位置同期
  - 現在の編集位置に対応するプレビュー位置への自動スクロール
  - 双方向スクロール連動（高度なオプション）

### レイアウト切り替え

- [ ] 表示モード切り替え機能
  - 分割表示 / エディタのみ / プレビューのみ
  - ユーザー設定の保存（localStorage）

## 7. テスト方法

### 単体テスト

- [ ] MarkdownPreview.test.tsx の作成
  - 基本的なレンダリングテスト
  - マークダウン変換の正確性テスト

### 手動テスト

- [ ] 開発サーバーでの動作確認
  - 様々なマークダウン要素（見出し、リスト、テーブル等）のレンダリング確認
  - エディタ編集時のリアルタイムプレビュー更新確認
  - レスポンシブ表示での振る舞い確認

## 8. パフォーマンス最適化 (オプション)

### レンダリング最適化

- [ ] メモ化による不要な再レンダリングの防止
  - useCallback, useMemo, React.memo の活用
- [ ] Markdownパース処理の最適化
  - 大きなドキュメントでの遅延読み込みやスケルトン表示

## 完了条件

- [ ] `pnpm dev` でのプレビュー動作確認
  - エディタでの編集が即時にMarkdownプレビューに反映されること
  - マークダウン要素が期待通りにレンダリングされること
- [ ] 実装が以下の要件を満たすこと
  - YAML編集とMarkdownプレビューの分割表示
  - YAMLのcontentフィールドの内容が正しくマークダウンとして表示
  - エラー時の適切なフィードバック表示
- [ ] 以下のファイルが作成され正常に動作すること:
  - components/MarkdownPreview.tsx
  - hooks/useMarkdownContent.ts（オプション）
  - 更新されたApp.tsx

## 残課題と将来拡張

- [ ] プレビューのテーマ切り替え機能
- [ ] 画像のサポート（ローカルファイルリンクや埋め込み）
- [ ] カスタムマークダウン拡張（数式、図表など）
- [ ] エディタとプレビュー間のカーソル位置同期
- [ ] 印刷用スタイルの最適化