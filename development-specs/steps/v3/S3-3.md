# S3-3: Markdownコンテンツのスキーマ検証改善

## 目的
現在のMarkdown本文のスキーマ検証にはバグがあり、フロントマターを除外したコンテンツ部分が正しく検証されていない。エラーが常に1行目として表示され、スキーマが要求する「sections」フィールドが欠落しているエラーが発生している。これを修正し、Markdown本文の構造を適切にYAMLに変換したうえで正確な検証を行えるようにする。

## 背景
現状では、Markdownをスキーマ検証する際に以下の問題がある：

1. **不適切なYAML変換処理**: 現在使用されている`md_to_yaml`関数は、Markdownから単にタイトルとコンテンツだけを持つ単純なYAMLを生成しており、スキーマが期待する「sections」フィールドなどの構造化データを生成していない。

2. **不完全な行番号決定アルゴリズム**: エラーの行番号を特定するためのアルゴリズムが不十分で、存在しないフィールドに対しては常に1行目など不正確な行番号が返される。

3. **想定と実際のスキーマの不一致**: 使用されているスキーマが「sections」フィールドを必須としているが、実際に生成されるYAMLには「sections」フィールドが含まれていない。

## 解決策

以下の3つの解決策を提案し、それぞれの詳細と実装方法を示す。

### 解決策1: md_headings_to_yaml関数の活用

#### 目的
既存の`md_headings_to_yaml`関数を使用して、Markdown見出し構造を適切に解析し、スキーマが期待する構造を持つYAMLを生成する。

#### 実装内容
1. `useValidator.ts`内の`markdownToYaml`関数の実装を修正し、WASM側の`md_headings_to_yaml`関数を呼び出すよう変更する。
2. 必要に応じて引数を調整し、正しく見出し構造が解析されるようにする。

#### 作業手順
1. `packages/core-wasm/src/md_transform.rs`の`md_headings_to_yaml`関数の詳細を確認し、入出力仕様を把握する。
2. `apps/web/src/hooks/useValidator.ts`内の`markdownToYaml`関数を修正し、適切な関数を呼び出すようにする。
3. 必要に応じて、Typescript側の型定義や関数インターフェースを調整する。
4. 単体テストを実装し、Markdown→YAML変換が正しく行われることを確認する。

#### 完了条件
- Markdownの見出し構造が正しくYAMLの階層構造に変換される
- 生成されたYAMLに「sections」フィールドが含まれている
- スキーマ検証でエラーが発生した場合、適切な行番号が表示される
- 単体テストが成功する

### 解決策2: スキーマの期待に合わせたYAML生成処理の改良

#### 目的
`useValidator.ts`内でMarkdownを解析し、見出しレベルに応じた階層構造（sections含む）をTypeScript側で構築してからスキーマ検証を行う。

#### 実装内容
1. `useValidator.ts`内に新たにMarkdown解析用の関数を実装する。
2. 見出しレベルに応じた階層構造を構築するロジックを実装する。
3. 構築された構造からYAML文字列を生成する処理を実装する。

#### 作業手順
1. Markdownを解析するライブラリ（既存または新規）を選定・導入する。
2. `apps/web/src/hooks/useValidator.ts`内に新たな関数を実装する。
3. 見出しレベルに応じた階層構造を構築するロジックを実装する。
4. 構築した構造体からYAML文字列を生成する処理を実装する。
5. 単体テストを実装し、Markdown解析が正しく行われることを確認する。

#### 完了条件
- Markdownの見出し構造が正しくTypeScript側で解析される
- 生成されたYAMLに「sections」フィールドが含まれている
- スキーマ検証でエラーが発生した場合、適切な行番号が表示される
- 単体テストが成功する

### 解決策3: 行番号検出アルゴリズムの改善

#### 目的
`find_line_for_path`関数を改良して、存在しないフィールドに対するエラー行番号の特定精度を向上させる。

#### 実装内容
1. `packages/core-wasm/src/validate.rs`内の`find_line_for_path`関数を改良する。
2. JSONパスから適切な行番号を特定するアルゴリズムを実装する。
3. 存在しないフィールドに対するエラー表示を改善する。

#### 作業手順
1. `find_line_for_path`関数の現状の実装を分析する。
2. JSONパスからYAMLの行番号を特定する改良アルゴリズムを設計する。
3. 存在しないフィールドに対する処理を実装する。
4. 単体テストを実装し、行番号特定が正しく行われることを確認する。

#### 完了条件
- スキーマ検証エラー時に、エラーの発生箇所に対応する正確な行番号が特定される
- 存在しないフィールドに対するエラーの場合も、関連する行番号が適切に表示される
- 単体テストが成功する

## 推奨される解決策

上記3つの解決策のうち、最も推奨されるのは**解決策1: md_headings_to_yaml関数の活用**である。理由は以下の通り：

1. 既存の機能を最大限に活用するため、実装の複雑さが最小限に抑えられる
2. Rustで実装されているため、パフォーマンスが高い
3. WASM連携部分が最小限の変更で済む

ただし、解決策1を実装しても行番号の特定精度に問題が残る可能性があるため、解決策3との組み合わせも検討する価値がある。

## 影響範囲

この変更により影響を受けるファイルは以下の通り：

- `apps/web/src/hooks/useValidator.ts`: Markdown→YAML変換処理の修正
- `packages/core-wasm/src/md_transform.rs`: 必要に応じて関数の改良
- `packages/core-wasm/src/validate.rs`: 行番号検出アルゴリズムの改善（解決策3の場合）
- 単体テスト関連ファイル

## テスト計画

以下のテストを実施して、修正の有効性を確認する：

1. 様々な見出し構造を持つMarkdownファイルを用意し、正しくYAMLに変換されることを確認
2. スキーマに違反するMarkdownファイルを用意し、適切なエラーメッセージと正確な行番号が表示されることを確認
3. 既存のテストケースが正常に動作することを確認

## 参考資料

分析のために必要なファイル：
- apps/web/src/hooks/useValidator.ts
- packages/core-wasm/src/md_transform.rs
- packages/core-wasm/src/validate.rs
- apps/web/public/schemas/note.schema.yaml