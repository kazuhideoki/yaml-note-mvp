# 実装手順: フェーズ7 - Schema編集 & Validation トグル

## 概要

フェーズ7では、JSON Schemaの編集および検証（バリデーション）のON/OFF切り替え機能を実装します。この機能により、ユーザーはYAMLデータの検証を一時的に無効化してスキーマの編集や柔軟なデータ入力が可能になり、必要に応じて再度検証を有効化できるようになります。

フェーズ7には主に2つの中心機能があります：
1. **compile_schema API**: スキーマ自体の検証を行うRust/WASM機能
2. **バリデーショントグル**: UI上でバリデーションのON/OFFを切り替える機能

これらの機能を組み合わせることで、ユーザーは柔軟にスキーマ編集とYAML作成ができるようになります。

## 達成基準

- [ ] `compile_schema` APIの実装（スキーマ自体の検証を行う）
- [ ] バリデーションのON/OFF切り替え機能の実装
- [ ] バリデーション時のエラー表示/非表示の制御
- [ ] バリデーションOFF時のスキーマ編集機能の提供
- [ ] (オプション) バリデーションOFF時のスキーマ自動生成機能

## 必要な依存関係

- Rust:
  - `jsonschema-valid`: JSON Schemaの検証に使用
  - `serde_yaml`/`serde_json`: YAMLおよびJSONの処理
  - `wasm-bindgen`: WASMインターフェイス

- Frontend:
  - React hooks: 状態管理
  - Tailwind CSS: UIコンポーネント

## 実装ステップ

### 1. WASM/Rustレイヤーの実装

#### 1.1. `validate.rs` に `compile_schema` 関数を追加

- [ ] JSON Schemaを受け取り、そのスキーマ自体が有効かどうかを検証する関数を実装する
- [ ] エラー情報を構造化して返す機能を含める
- [ ] スキーマのパース・コンパイル・検証プロセスを実装する
- [ ] Draft7形式のJSON Schemaに対応する

#### 1.2. テストケースの作成

- [ ] 有効なスキーマを検証するテスト
- [ ] 無効なスキーマタイプを検証するテスト
- [ ] スキーマバージョン指定なしのケースをテスト

#### 1.3. `lib.rs` に WASM バインディングを追加

- [ ] `compile_schema` 関数にWASMバインディングを追加
- [ ] 適切なシグネチャとドキュメンテーションを含める

#### 1.4. Cargoパッケージをビルド

- [ ] WASMモジュールをビルドして動作確認

### 2. フロントエンド実装 - 型定義とバリデーションフック

#### 2.1. TypeScript型定義の拡張

- [ ] ValidationError・ValidationResult・SchemaCompilationResultインターフェイスを作成/拡張
- [ ] 適切な型アノテーションとドキュメンテーションを含める

#### 2.2. WASMの型定義を更新

- [ ] core-wasm.d.tsファイルに新しい関数の型定義を追加
- [ ] コンパイラによる型チェックを確認

#### 2.3. バリデーション状態管理フックの作成

- [ ] `useValidationToggle` フックを実装:
  - [ ] バリデーション状態のON/OFF管理
  - [ ] localStorage連携で設定を永続化
  - [ ] トグル・有効化・無効化関数の提供

#### 2.4. `useYaml` フックを拡張

- [ ] validationEnabledパラメータを追加
- [ ] バリデーション無効時の処理をスキップする条件分岐追加
- [ ] スキーマ自体を検証する関数を追加
- [ ] 依存配列に新しいパラメータを追加

### 3. フロントエンド実装 - UI コンポーネント

#### 3.1. ValidationToggleコンポーネントの作成

- [ ] トグルスイッチUIコンポーネントを実装
- [ ] ON/OFF状態に応じた視覚的フィードバック
- [ ] アクセシビリティ対応（ARIA属性など）
- [ ] ツールチップによる機能説明

#### 3.2. ValidationBannerコンポーネントの作成

- [ ] バリデーション無効時に表示する通知バナーを実装
- [ ] ユーザーへの機能説明と注意喚起

#### 3.3. App.tsxの更新

- [ ] ValidationToggleをツールバーに追加
- [ ] useValidationToggleフックを統合
- [ ] バリデーション状態に応じた条件分岐を追加
- [ ] loggerを利用してトグル状態変更をログ出力

#### 3.4. EditorTabsの更新

- [ ] Schema編集タブでのバリデーション状態反映
- [ ] バリデーションOFF時のスキーマ編集モード表示
- [ ] ValidationBannerコンポーネントの表示制御

### 4. (オプション) スキーマ自動生成機能

#### 4.1. YAML解析からスキーマ生成ロジックの実装

- [ ] YAMLデータ構造を分析するユーティリティ関数
- [ ] 基本的なJSON Schemaを生成する関数
- [ ] 型推論ロジックの実装

#### 4.2. UI統合

- [ ] 「スキーマ自動生成」ボタンの追加
- [ ] 生成プロセスのフィードバック表示
- [ ] スキーマ保存機能

### 5. テスト手順

#### 5.1. Rust単体テスト

- [ ] `cargo test` コマンドで単体テスト実行
- [ ] スキーマコンパイル関数のテスト確認

#### 5.2. TypeScript型チェック

- [ ] `pnpm typecheck` コマンドで型チェック実行

#### 5.3. 機能テスト

- [ ] バリデーショントグルの動作確認:
  - [ ] ON → OFF でエラー表示が消えることを確認
  - [ ] OFF → ON で再度エラー表示されることを確認
- [ ] スキーマ編集の確認:
  - [ ] バリデーションON時にはスキーマエラーが表示される
  - [ ] バリデーションOFF時には無効なスキーマも編集可能
- [ ] (実装した場合) スキーマ自動生成の確認

## 実装の注意点

1. **パフォーマンス考慮**: バリデーション切り替え時の再レンダリングを最小限に抑える設計を心がける

2. **UX配慮**: バリデーション状態が分かりやすいUI表現を使用し、ユーザーが現在のモードを常に認識できるようにする

3. **エラーハンドリング**: WASMモジュールとの通信エラーや想定外の状態に対する適切なフォールバック処理を実装

4. **拡張性**: 将来的なスキーマバージョン対応やバリデーションルールのカスタマイズに対応できる設計を検討

## 次のステップ

フェーズ7の完了後は、フェーズ8「Live Preview & UX 改善」に移行します。そこでは、リアルタイムプレビューの強化やショートカット、Undo履歴などのUX改善に取り組みます。
